name: Build and Release Kernels
permissions:
  contents: write
  actions: write
 
on:
  workflow_dispatch:
    inputs:
      device:
        description: 'Device codename'
        required: true
        type: string
        default: 'shusky'
      ksu_type:
        description: 'KernelSU type'
        required: true
        type: choice
        options:
          - ksu-next
          - ksu
        default: 'ksu-next'
      susfs:
        description: 'Enable SUSFS?'
        required: true
        type: boolean
        default: true
      debug_module_list:
        description: 'Build Debug Module List?'
        required: false
        type: boolean
        default: false
      stock_ota:
        description: 'Stock Full OTA'
        required: true
        type: choice
        options:
          - shiba-bp3a.250905.014-factory-f927be20.zip
        default: shiba-bp3a.250905.014-factory-f927be20.zip
      pixel-source-branch:
        description: 'Pixel Source Branch'
        required: true
        type: choice
        options:
          - android-gs-shusky-6.1-android16
        default: android-gs-shusky-6.1-android16
      aosp-spoofing:
        description: 'Enable AOSP Spoofing?'
        required: false
        type: string
        default: android14-6.1-2025-05_r8
      hooks_type:
        description: 'Hooks Type'
        required: true
        type: choice
        options:
          - manual
          - kbrobes
        default: kbrobes
      run_type:
        description: 'Run Type'
        required: true
        type: choice
        options:
          - manual
          - matrix
        default: 'manual'

jobs:
  # Мануальная сборка с пользовательскими параметрами
  build-kernel-manual:
    if: github.event.inputs.run_type == 'manual'
    uses: ./.github/workflows/build.yml
    with:
      device: ${{ github.event.inputs.device }}
      ksu_type: ${{ github.event.inputs.ksu_type }}
      susfs: ${{ github.event.inputs.susfs }}
      debug_module_list: ${{ github.event.inputs.debug_module_list }}
      stock_ota: ${{ github.event.inputs.stock_ota }}
      pixel-source-branch: ${{ github.event.inputs.pixel-source-branch }}
      aosp-spoofing: ${{ github.event.inputs.aosp-spoofing }}
      hooks_type: ${{ github.event.inputs.hooks_type }}

  # Матричная сборка с комбинированием ksu_type, susfs и hooks_type
  build-kernel-matrix:
    if: github.event.inputs.run_type == 'matrix'
    strategy:
      matrix:
        ksu_type: [ksu-next, ksu]
        susfs: [true, false]
        hooks_type: [manual, kbrobes]
        exclude:
          # Запрещаем комбинацию ksu + manual
          - ksu_type: ksu
            hooks_type: manual
    uses: ./.github/workflows/build.yml
    with:
      device: 'shusky'
      ksu_type: ${{ matrix.ksu_type }}
      susfs: ${{ matrix.susfs }}
      debug_module_list: false
      stock_ota: 'shiba-bp3a.250905.014-factory-f927be20.zip'
      pixel-source-branch: 'android-gs-shusky-6.1-android16'
      aosp-spoofing: 'android14-6.1-2025-05_r8'
      hooks_type: ${{ matrix.hooks_type }}